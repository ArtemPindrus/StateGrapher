<UserControl
    x:Class="StateGrapher.StateMachineView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:StateGrapher"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:nodify="https://miroiu.github.io/nodify"
    xmlns:o="http://schemas.microsoft.com/winfx/2006/xaml/presentation/options"
    xmlns:viewmodels="clr-namespace:StateGrapher.ViewModels"
    d:DataContext="{d:DesignInstance Type=viewmodels:StateMachineViewModel}"
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d">
    <Grid Visibility="{Binding IsExpanded, Converter={StaticResource BooleanToVisibilityConverter}}">
        <Grid.Resources>
            <GeometryDrawing
                x:Key="SmallGridGeometry"
                Brush="Gray"
                Geometry="M0,0 L0,1 0.03,1 0.03,0.03 1,0.03 1,0 Z" />

            <GeometryDrawing
                x:Key="LargeGridGeometry"
                Brush="LightGray"
                Geometry="M0,0 L0,1 0.015,1 0.015,0.015 1,0.015 1,0 Z" />

            <DrawingBrush
                x:Key="SmallGridLinesDrawingBrush"
                Drawing="{StaticResource SmallGridGeometry}"
                TileMode="Tile"
                Transform="{Binding ViewportTransform, ElementName=NodeEditor}"
                Viewport="0 0 15 15"
                ViewportUnits="Absolute" />

            <DrawingBrush
                x:Key="LargeGridLinesDrawingBrush"
                Drawing="{StaticResource LargeGridGeometry}"
                Opacity="0.5"
                TileMode="Tile"
                Transform="{Binding ViewportTransform, ElementName=NodeEditor}"
                Viewport="0 0 150 150"
                ViewportUnits="Absolute" />
        </Grid.Resources>


        <nodify:NodifyEditor
            Name="NodeEditor"
            Background="{StaticResource SmallGridLinesDrawingBrush}"
            ConnectionCompletedCommand="{Binding AddConnectionCommand}"
            Connections="{Binding Connections}"
            ContextMenu="{DynamicResource CreateContextMenu}"
            DisableAutoPanning="{Binding RelativeSource={RelativeSource AncestorType=local:StateMachineView}, Path=IsStiff}"
            DisablePanning="{Binding RelativeSource={RelativeSource AncestorType=local:StateMachineView}, Path=IsStiff}"
            DisableZooming="{Binding RelativeSource={RelativeSource AncestorType=local:StateMachineView}, Path=IsStiff}"
            DisplayConnectionsOnTop="True"
            GridCellSize="15"
            ItemsSource="{Binding Nodes}"
            SelectedConnection="{Binding SelectedConnection, Mode=OneWayToSource}"
            SelectedItem="{Binding SelectedNode, Mode=OneWayToSource}">
            <nodify:NodifyEditor.Resources>
                <!--  StickyNode  -->
                <DataTemplate DataType="{x:Type viewmodels:StickyNodeViewModel}">
                    <Border Padding="5" Background="LightYellow">
                        <Expander Background="LightYellow" Header="StickyNote">
                            <Expander.Content>
                                <TextBox Style="{StaticResource TransparentTextBox}" Text="{Binding Text, UpdateSourceTrigger=PropertyChanged}" />
                            </Expander.Content>
                        </Expander>
                    </Border>
                </DataTemplate>

                <!--  InitialStateNode  -->
                <DataTemplate DataType="{x:Type viewmodels:InitialStateViewModel}">
                    <Grid>
                        <Ellipse
                            Width="30"
                            Height="30"
                            Fill="Blue" />

                        <nodify:Connector DataContext="{Binding Connector}" Style="{StaticResource ConnectorStyle}" />
                    </Grid>
                </DataTemplate>

                <!--  ExitNode  -->
                <DataTemplate DataType="{x:Type viewmodels:ExitNodeViewModel}">
                    <DockPanel>
                        <TextBlock HorizontalAlignment="Center" DockPanel.Dock="Top">
                            <Run Text="exit : " />
                            <Run Text="{Binding Name}" />
                        </TextBlock>

                        <Grid>
                            <Ellipse
                                Width="30"
                                Height="30"
                                Fill="GreenYellow"
                                Stroke="Green"
                                StrokeThickness="2.5" />

                            <nodify:Connector DataContext="{Binding Connector}" Style="{StaticResource ConnectorStyle}" />
                        </Grid>
                    </DockPanel>
                </DataTemplate>

                <!--  StateMachine  -->
                <DataTemplate DataType="{x:Type viewmodels:StateMachineViewModel}">
                    <DockPanel>
                        <!--  Top Connectors  -->
                        <UniformGrid
                            Columns="3"
                            DockPanel.Dock="Top"
                            Rows="1">
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.TopConnectors[0]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.TopConnectors[1]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.TopConnectors[2]}"
                                Style="{StaticResource ConnectorStyle}" />
                        </UniformGrid>

                        <!--  Bottom Connectors  -->
                        <UniformGrid
                            Columns="3"
                            DockPanel.Dock="Bottom"
                            Rows="1">
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.BottomConnectors[0]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.BottomConnectors[1]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                VerticalAlignment="Top"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.BottomConnectors[2]}"
                                Style="{StaticResource ConnectorStyle}" />
                        </UniformGrid>

                        <!--  Right Connectors  -->
                        <UniformGrid
                            Columns="1"
                            DockPanel.Dock="Right"
                            Rows="3">
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.RightConnectors[0]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.RightConnectors[1]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.RightConnectors[2]}"
                                Style="{StaticResource ConnectorStyle}" />
                        </UniformGrid>

                        <!--  Left Connectors  -->
                        <UniformGrid
                            Columns="1"
                            DockPanel.Dock="Left"
                            Rows="3">
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.LeftConnectors[0]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.LeftConnectors[1]}"
                                Style="{StaticResource ConnectorStyle}" />
                            <nodify:Connector
                                HorizontalAlignment="Center"
                                Anchor="{Binding Anchor, Mode=OneWayToSource}"
                                DataContext="{Binding Connectors.LeftConnectors[2]}"
                                Style="{StaticResource ConnectorStyle}" />
                        </UniformGrid>

                        <nodify:GroupingNode
                            ActualSize="{Binding Size}"
                            CanResize="{Binding IsExpanded}"
                            Header="{Binding}"
                            MovementMode="Self">
                            <Grid>
                                <local:StateMachineView IsStiff="True" />
                            </Grid>

                            <nodify:GroupingNode.HeaderTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding IsExpanded}" />

                                            <TextBox
                                                HorizontalAlignment="Left"
                                                AcceptsReturn="False"
                                                AcceptsTab="False"
                                                CaretBrush="Wheat"
                                                Foreground="White"
                                                Style="{StaticResource TransparentTextBox}"
                                                Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>

                            </nodify:GroupingNode.HeaderTemplate>
                        </nodify:GroupingNode>
                    </DockPanel>
                </DataTemplate>
            </nodify:NodifyEditor.Resources>


            <!--  ItemContainerStyle  -->
            <nodify:NodifyEditor.ItemContainerStyle>
                <Style BasedOn="{StaticResource {x:Type nodify:ItemContainer}}" TargetType="{x:Type nodify:ItemContainer}">
                    <Setter Property="Location" Value="{Binding Location}" />
                    <Setter Property="Tag" Value="{Binding RelativeSource={RelativeSource AncestorType=local:StateMachineView}, Path=DataContext}" />
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem
                                    Command="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.Tag.DeleteNodeCommand}"
                                    CommandParameter="{Binding}"
                                    Header="Delete" />
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </nodify:NodifyEditor.ItemContainerStyle>

            <!--  ConnectionTemplate  -->
            <nodify:NodifyEditor.ConnectionTemplate>
                <DataTemplate DataType="{x:Type viewmodels:ConnectionViewModel}">
                    <nodify:CircuitConnection
                        ArrowEnds="{Binding IsBothWays, Converter={StaticResource BoolToArrowEnds}}"
                        Direction="{Binding Direction}"
                        IsSelectable="True"
                        OutlineBrush="Transparent"
                        OutlineThickness="3"
                        Source="{Binding From.Anchor}"
                        SourceOffset="0,0"
                        SourceOffsetMode="None"
                        SourceOrientation="{Binding SourceOrientation}"
                        Spacing="0"
                        Stroke="Wheat"
                        Target="{Binding To.Anchor}"
                        TargetOffset="0,0"
                        TargetOffsetMode="None"
                        TargetOrientation="{Binding TargetOrientation}"
                        Text="{Binding EventDisplayName}">
                        <nodify:CircuitConnection.ContextMenu>
                            <ContextMenu>
                                <MenuItem Command="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.DataContext.RemoveCommand}" Header="Delete" />
                            </ContextMenu>
                        </nodify:CircuitConnection.ContextMenu>
                    </nodify:CircuitConnection>
                </DataTemplate>
            </nodify:NodifyEditor.ConnectionTemplate>
        </nodify:NodifyEditor>

        <Grid Panel.ZIndex="-1" Background="{StaticResource LargeGridLinesDrawingBrush}" />

    </Grid>
</UserControl>
